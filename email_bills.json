{
  "name": "email_bills",
  "nodes": [
    {
      "parameters": {
        "jsCode": "const XLSX = require('xlsx');\n\n// 1. Read binary buffer\nconst buffer = Buffer.from(items[0].binary.main.data, 'base64');\nconst workbook = XLSX.read(buffer, { type: 'buffer' });\n\n// 2. Read the first sheet as JSON\nconst sheet = workbook.Sheets[workbook.SheetNames[0]];\nconst rows = XLSX.utils.sheet_to_json(sheet, { defval: 0 });\n\n// 3. Group and aggregate data\nconst result = {};\n\nrows.forEach(row => {\n  const name = row['å§“å']?.toString().trim();\n  const company = row['å…¬å¸åˆ«']?.toString().trim();\n  if (!name || !company) return;\n\n  const key = `${name}|${company}`;\n  if (!result[key]) {\n    result[key] = {\n      name,\n      company,\n      travel_M: 0,\n      hotel_M: 0,\n      didi_M: 0\n    };\n  }\n\n  const travel = parseFloat(row['(æœºç¥¨/ç«è½¦ç¥¨)ç¾å›¢202611']) || 0;\n  const hotel = parseFloat(row['(ä½å®¿è´¹)ç¾å›¢202611']) || 0;\n  const didi = parseFloat(row['(äº¤é€šè´¹)æ»´æ»´202754']) || 0;\n\n  result[key].travel_M += travel;\n  result[key].hotel_M += hotel;\n  result[key].didi_M += didi;\n});\n\n// 4. Format and return\nconst output = Object.values(result).map(entry => ({\n  json: {\n    name: entry.name,\n    company: entry.company,\n    travel_M: Math.round(entry.travel_M * 100) / 100,\n    hotel_M: Math.round(entry.hotel_M * 100) / 100,\n    didi_M: Math.round(entry.didi_M * 100) / 100\n  }\n}));\n\nreturn output;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -360,
        -260
      ],
      "id": "06ec12f8-c91c-4131-92ee-0ac639ab1de8",
      "name": "å°è´¦æ€»è®¡"
    },
    {
      "parameters": {
        "jsCode": "const XLSX = require('xlsx');\n\nconst buffer = Buffer.from(items[0].binary.didi.data, 'base64');\nconst workbook = XLSX.read(buffer, { type: 'buffer' });\n\nconst sheetNames = workbook.SheetNames.slice(1); // skip the first sheet\nconst output = [];\n\nsheetNames.forEach(sheetName => {\n  const sheet = workbook.Sheets[sheetName];\n  const rows = XLSX.utils.sheet_to_json(sheet, { defval: 0 });\n\n  const temp = {};\n\n  rows.forEach(row => {\n    const name = row['ä¸‹å•äººå§“å']?.toString().trim();\n    const mode = row['ç”¨è½¦åˆ¶åº¦'];\n    let amount = parseFloat(row['å®é™…è½¦è´¹é‡‘é¢']);\n    if (!name || mode !== 'å·®æ—…æ‰“è½¦' || isNaN(amount)) return;\n\n    if (!temp[name]) temp[name] = 0;\n    temp[name] += amount;\n  });\n\n  for (const [name, rawSum] of Object.entries(temp)) {\n    output.push({\n      name,\n      company: sheetName,\n      didi: Math.round(rawSum * 100) / 100\n    });\n  }\n});\n\nreturn output.map(entry => ({ json: entry }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -360,
        -160
      ],
      "id": "7289dd5e-df84-4602-9995-de57cc3101f5",
      "name": "æ»´æ»´æ€»è®¡"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "c3fdbc2c-31cc-4fd5-94e6-e6aa6c0a7edb",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -540,
        -60
      ],
      "id": "596d3f59-e182-4da9-bdf3-9185df35b1f2",
      "name": "Webhook",
      "webhookId": "c3fdbc2c-31cc-4fd5-94e6-e6aa6c0a7edb"
    },
    {
      "parameters": {
        "jsCode": "const XLSX = require('xlsx');\n\nconst sheetConfigs = [\n  { sheet: 'å›½å†…æœºç¥¨', nameCol: 'ä¹˜æœºäºº', type: 'plane' },\n  { sheet: 'ç«è½¦ç¥¨', nameCol: 'ä¹˜è½¦äºº', type: 'train' },\n  { sheet: 'é…’åº—', nameCol: 'å…¥ä½äºº', type: 'hotel' }\n];\n\nfunction assignCode(company) {\n  if (company.includes('ç»å¼€')) return '165G';\n  if (company.includes('å¤§è¿') && company.includes('æˆéƒ½')) return '16DC';\n  if (company.includes('å¤§è¿') && company.includes('åŒ—äº¬')) return '16DA';\n  if (company.includes('åŒ—äº¬')) return '165A';\n  if (company.includes('å¹¿å·')) return '165M';\n  if (company.includes('æ·±åœ³')) return '165R';\n  return '1650';\n}\n\nconst allOutput = [];\n\nfor (const item of items) {\n  for (const [key, file] of Object.entries(item.binary)) {\n    if (!key.startsWith('meituan')) continue;\n\n    const buffer = Buffer.from(file.data, 'base64');\n    const workbook = XLSX.read(buffer, { type: 'buffer' });\n\n    const companyName = file.fileName.replace('.xlsx', '');\n    const assignedCode = assignCode(companyName);\n\n    const temp = {};\n\n    for (const cfg of sheetConfigs) {\n      const sheet = workbook.Sheets[cfg.sheet];\n      if (!sheet) continue;\n\n      const rows = XLSX.utils.sheet_to_json(sheet, { defval: 0 });\n\n      for (const row of rows) {\n        const name = row[cfg.nameCol]?.toString().trim();\n        if (!name) continue;\n\n        let amount = parseFloat(row['è®¢å•å®ä»˜é‡‘é¢ï¼ˆä¼ä¸šï¼‰']);\n        if (isNaN(amount)) amount = 0;\n\n        if (!temp[name]) {\n          temp[name] = {\n            name,\n            company: assignedCode,\n            plane: 0,\n            train: 0,\n            hotel: 0\n          };\n        }\n\n        temp[name][cfg.type] += amount;\n      }\n    }\n\n    // Push results for this file\n    Object.values(temp).forEach(entry => {\n      allOutput.push({\n        json: {\n          name: entry.name,\n          company: entry.company,\n          travel: Math.round((entry.plane + entry.train) * 100) / 100,\n          hotel: Math.round(entry.hotel * 100) / 100\n        }\n      });\n    });\n  }\n}\n\nreturn allOutput;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -360,
        -60
      ],
      "id": "1890a8e6-2cba-4be8-bf73-7d5eba780b5d",
      "name": "ç¾å›¢æ€»è®¡"
    },
    {
      "parameters": {
        "jsCode": "const grouped = {};\n\nitems.forEach(item => {\n  const { name, company, travel, hotel, didi, travel_M, hotel_M, didi_M } = item.json;\n  if (!name || !company) return;\n\n  if (!grouped[company]) grouped[company] = {};\n  if (!grouped[company][name]) grouped[company][name] = {\n    meituan: { travel: 0, hotel: 0 },\n    main: { travel: 0, hotel: 0, didi: 0 },\n    didi: 0\n  };\n\n  // å°è´¦ï¼ˆmainï¼‰fields\n  if (travel_M !== undefined) grouped[company][name].main.travel = travel_M;\n  if (hotel_M !== undefined) grouped[company][name].main.hotel = hotel_M;\n  if (didi_M !== undefined) grouped[company][name].main.didi = didi_M;\n\n  // ç¾å›¢ fields\n  if (travel !== undefined) grouped[company][name].meituan.travel = travel;\n  if (hotel !== undefined) grouped[company][name].meituan.hotel = hotel;\n\n  // æ»´æ»´ fields (å°è´¦ä¸­)\n  if (didi !== undefined) grouped[company][name].didi = didi;\n});\n\nconst report = {};\n\nfor (const [company, users] of Object.entries(grouped)) {\n  let totalMeituanTravel = 0;\n  let totalMeituanHotel = 0;\n  let totalDidi = 0;\n\n  let totalMainTravel = 0;\n  let totalMainHotel = 0;\n  let totalMainDidi = 0;\n\n  let totalDiffHotel = 0;\n  let totalDiffTicket = 0;\n  let totalDiffDidi = 0;\n\n  const table = [];\n\n  for (const [name, data] of Object.entries(users)) {\n    const m = data.meituan || {};\n    const t = data.main || {};\n    const d = data.didi ?? 0;\n\n    const meituanTravel = m.travel || 0;\n    const meituanHotel = m.hotel || 0;\n    const mainTravel = t.travel || 0;\n    const mainHotel = t.hotel || 0;\n    const mainDidi = t.didi || 0;\n\n    const diffHotel = Math.round((meituanHotel - mainHotel) * 100) / 100;\n    const diffTicket = Math.round((meituanTravel - mainTravel) * 100) / 100;\n    const diffDidi = Math.round((d - mainDidi) * 100) / 100;\n\n    totalMeituanTravel += meituanTravel;\n    totalMeituanHotel += meituanHotel;\n    totalDidi += d;\n\n    totalMainTravel += mainTravel;\n    totalMainHotel += mainHotel;\n    totalMainDidi += mainDidi;\n\n    totalDiffHotel += diffHotel;\n    totalDiffTicket += diffTicket;\n    totalDiffDidi += diffDidi;\n\n    if (diffHotel !== 0 || diffTicket !== 0 || diffDidi !== 0) {\n      let reason = '';\n    \n      const hasMain = (mainTravel || mainHotel || mainDidi) > 0;\n      const hasMeituan = (meituanTravel || meituanHotel) > 0;\n      const hasDidi = d > 0;\n    \n      if (hasMain && !hasMeituan && !hasDidi) {\n        reason = `æ­¤(${name}, ${company}) ä»…äºå°è´¦ä¸­å‡ºç°`;\n      } else if (!hasMain && (hasMeituan || hasDidi)) {\n        reason = `æ­¤(${name}, ${company}) ä»…äº${hasDidi ? 'æ»´æ»´' : 'ç¾å›¢'}è´¦å•ä¸­å‡ºç°`;\n      }\n    \n      table.push({\n        å§“å: name,\n        ä½å®¿è´¹å·®å¼‚: diffHotel,\n        ç¥¨æ¬¾å·®å¼‚: diffTicket,\n        æ»´æ»´å·®å¼‚: diffDidi,\n        å·®å¼‚åŸå› : reason\n      });\n}\n\n  }\n\n  table.push({\n    å§“å: 'å·®é¢æ€»è®¡',\n    ä½å®¿è´¹å·®å¼‚: Math.round(totalDiffHotel * 100) / 100,\n    ç¥¨æ¬¾å·®å¼‚: Math.round(totalDiffTicket * 100) / 100,\n    æ»´æ»´å·®å¼‚: Math.round(totalDiffDidi * 100) / 100\n  });\n\n  report[company] = {\n    summary: {\n      ç¾å›¢è´¦å•ç¥¨æ¬¾æ€»é‡‘é¢: Math.round(totalMeituanTravel * 100) / 100,\n      ç¾å›¢è´¦å•ä½å®¿è´¹æ€»é‡‘é¢: Math.round(totalMeituanHotel * 100) / 100,\n      æ»´æ»´è´¦å•æ€»é‡‘é¢: Math.round(totalDidi * 100) / 100,\n      å°è´¦ç¥¨æ¬¾æ€»é‡‘é¢: Math.round(totalMainTravel * 100) / 100,\n      å°è´¦ä½å®¿è´¹æ€»é‡‘é¢: Math.round(totalMainHotel * 100) / 100,\n      å°è´¦æ»´æ»´æ‰“è½¦æ€»é‡‘é¢: Math.round(totalMainDidi * 100) / 100,\n      ç¥¨æ¬¾å·®å¼‚é‡‘é¢: Math.round((totalMeituanTravel - totalMainTravel) * 100) / 100,\n      ä½å®¿è´¹å·®å¼‚é‡‘é¢: Math.round((totalMeituanHotel - totalMainHotel) * 100) / 100,\n      æ»´æ»´å·®å¼‚é‡‘é¢: Math.round((totalDidi - totalMainDidi) * 100) / 100\n    },\n    table\n  };\n}\n\nreturn [{ json: report }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -40,
        -220
      ],
      "id": "044c8ccc-63b0-416a-a412-285d3b96e86c",
      "name": "æœ€ç»ˆæ±‡æ€»"
    },
    {
      "parameters": {
        "jsCode": "const XLSX = require('xlsx');\n\n// Assume the input is a single JSON report object\nconst report = items[0].json;\n\n// Create a new workbook\nconst workbook = XLSX.utils.book_new();\n\nfor (const [company, data] of Object.entries(report)) {\n  const { summary, table } = data;\n\n  const sheetData = [];\n  // Section 1: Summary (split into 2 columns per item)\nsheetData.push([\n  'ç¾å›¢è´¦å•ç¥¨æ¬¾æ€»é‡‘é¢', summary['ç¾å›¢è´¦å•ç¥¨æ¬¾æ€»é‡‘é¢'],\n  'å°è´¦ç¥¨æ¬¾æ€»é‡‘é¢', summary['å°è´¦ç¥¨æ¬¾æ€»é‡‘é¢'],\n  'ç¥¨æ¬¾å·®å¼‚é‡‘é¢', summary['ç¥¨æ¬¾å·®å¼‚é‡‘é¢']\n]);\n\nsheetData.push([\n  'ç¾å›¢è´¦å•ä½å®¿è´¹æ€»é‡‘é¢', summary['ç¾å›¢è´¦å•ä½å®¿è´¹æ€»é‡‘é¢'],\n  'å°è´¦ä½å®¿è´¹æ€»é‡‘é¢', summary['å°è´¦ä½å®¿è´¹æ€»é‡‘é¢'],\n  'ä½å®¿è´¹å·®å¼‚é‡‘é¢', summary['ä½å®¿è´¹å·®å¼‚é‡‘é¢']\n]);\n\nsheetData.push([\n  'æ»´æ»´è´¦å•æ€»é‡‘é¢', summary['æ»´æ»´è´¦å•æ€»é‡‘é¢'],\n  'å°è´¦æ»´æ»´æ‰“è½¦æ€»é‡‘é¢', summary['å°è´¦æ»´æ»´æ‰“è½¦æ€»é‡‘é¢'],\n  'æ»´æ»´å·®å¼‚é‡‘é¢', summary['æ»´æ»´å·®å¼‚é‡‘é¢']\n]);\n\n  // Blank row\n  sheetData.push([]);\n\n  // Section 2: Table headers (now with 4 columns)\n  sheetData.push(['å…¬å¸åˆ«', 'ä½å®¿è´¹å·®å¼‚', 'ç«è½¦ç¥¨æœºç¥¨å·®å¼‚', 'å·®æ—…æ»´æ»´æ‰“è½¦å·®å¼‚', 'å·®å¼‚åŸå› ']);\n\n  // Section 3: Table content\n  table.forEach(entry => {\n    sheetData.push([\n      entry['å§“å'],\n      entry['ä½å®¿è´¹å·®å¼‚'],\n      entry['ç¥¨æ¬¾å·®å¼‚'],\n      entry['æ»´æ»´å·®å¼‚'],\n      entry['å·®å¼‚åŸå› '] || ''\n    ]);\n  });\n\n  // Create sheet\n  const worksheet = XLSX.utils.aoa_to_sheet(sheetData);\n  XLSX.utils.book_append_sheet(workbook, worksheet, company);\n}\n\n// Generate workbook buffer\nconst wbBuffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });\n\n// Return as binary\nreturn [\n  {\n    binary: {\n      data: {\n        data: wbBuffer.toString('base64'),\n        mimeType: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n        fileName: 'report.xlsx'\n      }\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        -220
      ],
      "id": "6208c246-0d30-4bfa-8233-4e5e41321770",
      "name": "Code"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        60,
        20
      ],
      "id": "597e11c6-7837-483f-8f2f-33418b8f06cd",
      "name": "Merge2"
    },
    {
      "parameters": {
        "fromEmail": "billrecon@wits.com",
        "toEmail": "={{ $items()[1].json.body.email }}",
        "subject": "æœˆåº¦è´¦å•å¯¹è´¦",
        "emailFormat": "text",
        "text": "ğŸ“ é™„ä»¶ä¸ºæœ¬æœˆå°è´¦å¯¹è´¦æ±‡æ€»è¡¨ã€‚\n\nè¡¨æ ¼ä¸­çš„å·®å¼‚æ•°å€¼å‡æŒ‰ è´¦å•é‡‘é¢ - å°è´¦é‡‘é¢ è®¡ç®—ã€‚\nå¦‚æŸå‘˜å·¥ä»…å‡ºç°åœ¨å°è´¦æˆ–è´¦å•ä¸­ï¼Œå·²åœ¨â€œå·®å¼‚åŸå› â€åˆ—ä¸­æ ‡æ³¨è¯´æ˜ã€‚\n\nå¦‚æœ‰ä»»ä½•ç–‘é—®ï¼Œæ¬¢è¿éšæ—¶è”ç³» ğŸ™",
        "options": {
          "attachments": "data"
        }
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        320,
        -20
      ],
      "id": "62291cb8-5afe-4e8d-84b4-602bf60a4591",
      "name": "Send Email1",
      "webhookId": "cc055911-2d8c-42cf-8d3d-de03268fef87",
      "credentials": {
        "smtp": {
          "id": "hpsV0DqeEWTu6Ciw",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -260,
        -120
      ],
      "id": "d0e1473e-8ba6-4d42-8f13-8c04cf09f7d9",
      "name": "Merge3"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -160,
        -220
      ],
      "id": "9d08bb38-9d01-4da8-95c3-749c899a0a1d",
      "name": "Merge4"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "å°è´¦æ€»è®¡",
            "type": "main",
            "index": 0
          },
          {
            "node": "æ»´æ»´æ€»è®¡",
            "type": "main",
            "index": 0
          },
          {
            "node": "ç¾å›¢æ€»è®¡",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "å°è´¦æ€»è®¡": {
      "main": [
        [
          {
            "node": "Merge4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ»´æ»´æ€»è®¡": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç¾å›¢æ€»è®¡": {
      "main": [
        [
          {
            "node": "Merge3",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "æœ€ç»ˆæ±‡æ€»": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Merge2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge2": {
      "main": [
        [
          {
            "node": "Send Email1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Email1": {
      "main": [
        []
      ]
    },
    "Merge3": {
      "main": [
        [
          {
            "node": "Merge4",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge4": {
      "main": [
        [
          {
            "node": "æœ€ç»ˆæ±‡æ€»",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "179bc15a-0fe0-48a5-a6ab-6a04bd2afaad",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "5a0a8368508e65c9e8ded88b205f493444df4e41b67e93e0a2a1102a8e99df6b"
  },
  "id": "gy1to6oOyrYiNYbI",
  "tags": []
}